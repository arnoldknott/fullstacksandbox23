# version: "3.9"

services:
  backend_api:
    build:
      target: api_dev
    depends_on:
      - postgres
      - redis
    env_file:
      - ./backend/src/.env
    ports:
      - "8660:80"
    volumes:
      - dev-app-data:/data
      # mount container app to development on localhost
      - ./backend/:/app
    restart: unless-stopped
    networks:
      - dev_network

  backend_worker:
    build:
      target: worker_dev
    depends_on:
      - backend_api
      - postgres
      - redis
    env_file:
      - ./backend/src/.env
    volumes:
      - dev-app-data:/data
      # mount container app to development on localhost
      - ./backend/:/app
    restart: unless-stopped
    networks:
      - dev_network

  postgres:
    container_name: dev_postgres
    # environment:
    #     - POSTGRES_HOST=$POSTGRES_HOST
    volumes:
      # Works in dev - wait until terraform azurerm supports version 18 for postgres, then update stage & prod!
      # - dev-postgres-data-18:/var/lib/postgresql/data/
      - dev-postgres-data:/var/lib/postgresql/data/
    env_file:
      - ./backend/src/.env
    ports:
      - "5432:5432"
    networks:
      - dev_network

  # Mainly replaced by pgadmin app - reinstate if changing from app to containerization for pgadmin:
  pgadmin:
    image: dpage/pgadmin4:9.11.0
    depends_on:
      - postgres
    env_file:
      - ./backend/src/.env
    environment:
      - PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=True
      # or
      # - MASTER_PASSWORD_REQUIRED=True
      # - LOG_LEVEL=10
      - GUNICORN_ACCESS_LOGFILE=/dev/null
      - PGADMIN_CONFIG_AUTHENTICATION_SOURCES=['oauth2', 'internal']
      - PGADMIN_CONFIG_OAUTH2_AUTO_CREATE_USER=True
    ports:
      - "5533:80"
    volumes:
      - dev-pgadmin-data:/var/lib/pgadmin
    restart: unless-stopped
    networks:
      - dev_network

  frontend_svelte:
    build:
      target: build
    env_file:
      - ./frontend_svelte/src/.env
    ports:
      - "8661:80"
    volumes:
      - ./frontend_svelte:/app
      #- /app/node_modules
      - ./frontend_svelte/node_modules:/app/node_modules
    restart: unless-stopped
    networks:
      - dev_network
    command:
      # sh -c "/bin/sh"
      sh -c "npm install && npm run dev"

  redis:
    container_name: dev_redis
    env_file:
      - ./backend/src/.env
    volumes:
      - dev-redis-data:/data
      - ./cache/redis.conf:/data/redis.conf:ro
      - ./cache/redis-full.conf:/data/redis-full.conf:ro
      # Note the template is read-only, the created user.acl is read write, so redis-cli can alter the user list.
      - ./cache/users_template.acl:/data/users_template.acl:ro
      - ./cache/entrypoint.sh:/data/entrypoint.sh:ro
    ports:
      # redis-stack-server port:
      # - "6379:6379"
      # redisInsight port:
      - "8001:8001"
    restart: unless-stopped
    networks:
      - dev_network

  redisInsight:
    image: redis/redisinsight:2.70
    container_name: redisinsight
    depends_on:
      - redis
    ports:
      - "5540:5540"
    volumes:
      - dev-redis-insight-data:/data
    restart: unless-stopped
    networks:
      - dev_network

  flower:
    build:
      context: ./backend
      target: worker_dev
    depends_on:
      - backend_worker
      - redis
    env_file:
      - ./backend/src/.env
    command: sh -c "sleep 3 && celery -A core.celery_app:celery_app flower --port=5555"
    ports:
      - "5555:5555"
    restart: unless-stopped
    networks:
      - dev_network

volumes:
  dev-postgres-data: # for postgres version 16.1-alpine
  dev-postgres-data-18: # for postgres version 18
  dev-pgadmin-data:
  dev-app-data:
  dev-redis-data:
  dev-redis-insight-data:

networks:
  dev_network:
