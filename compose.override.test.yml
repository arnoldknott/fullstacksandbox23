name: test-fssb23

services:
  backend_api:
    build:
      # context:
      #     ./backendAPI
      target: dev
    # image: backend_api:test
    depends_on:
      - postgres
    environment:
      - KEYVAULT_HEALTH=$KEYVAULT_HEALTH
      - APP_REG_CLIENT_ID
      - APP_CLIENT_SECRET
      - FRONTEND_SVELTE_ORIGIN
      - FRONTEND_SVELTE_FQDN
      - AZURE_TENANT_ID=$AZURE_TENANT_ID
      - AZURE_CLIENT_ID=$AZURE_CLIENT_ID
      - API_SCOPE=$API_SCOPE
      - BACK_CLIENT_SECRET=$BACK_CLIENT_SECRET
      - POSTGRES_HOST=$POSTGRES_HOST
      # - POSTGRES_PORT=$POSTGRES_PORT
      - POSTGRES_DB=$POSTGRES_DB
      - POSTGRES_USER=$POSTGRES_USER
      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      - REDIS_HOST=$REDIS_HOST
      - REDIS_PORT=$REDIS_PORT
      - REDIS_SESSION_DB=$REDIS_SESSION_DB
      - REDIS_PASSWORD=$REDIS_PASSWORD
    networks:
      - test_network
    ports:
      - "8670:80"
    volumes:
      - test-app-data:/data

  postgres:
    container_name: test_postgres
    volumes:
      - test-postgres-data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_HOST=$POSTGRES_HOST
      - POSTGRES_DB=$POSTGRES_DB
      - POSTGRES_USER=$POSTGRES_USER
      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD
    networks:
      - test_network

  frontend_svelte:
    build:
      target: build
      args:
        - REDIS_HOST=$REDIS_HOST
        - REDIS_PORT=$REDIS_PORT
        - REDIS_SESSION_DB=$REDIS_SESSION_DB
        - REDIS_PASSWORD=$REDIS_PASSWORD
        - APP_REG_CLIENT_ID=$APP_REG_CLIENT_ID
        - APP_CLIENT_SECRET=$APP_CLIENT_SECRET
        - AZURE_TENANT_ID=$AZURE_TENANT_ID
        - API_SCOPE=$API_SCOPE
    environment:
      - REDIS_HOST=$REDIS_HOST
      - REDIS_PORT=$REDIS_PORT
      - REDIS_SESSION_DB=$REDIS_SESSION_DB
      - REDIS_PASSWORD=$REDIS_PASSWORD
      - APP_REG_CLIENT_ID=$APP_REG_CLIENT_ID
      - APP_CLIENT_SECRET=$APP_CLIENT_SECRET
      - AZURE_TENANT_ID=$AZURE_TENANT_ID
      - API_SCOPE=$API_SCOPE
    networks:
      - test_network
    command:
      sh -c "npm install && npm run dev"
      # npm run dev
    volumes:
      - ./frontend_svelte:/app
      - /app/node_modules
      # - ./frontend_svelte/node_modules:/app/node_modules

  redis:
    container_name: test_redis
    image: redis/redis:8.2.2-alpine3.22
    environment:
      - REDIS_ARGS=$REDIS_ARGS
      - REDIS_PASSWORD=$REDIS_PASSWORD
      - REDIS_SESSION_PASSWORD=$REDIS_SESSION_PASSWORD
      - REDIS_SOCKETIO_PASSWORD=$REDIS_SOCKETIO_PASSWORD
      - REDIS_WORKER_PASSWORD=$REDIS_WORKER_PASSWORD
    volumes:
      - test-redis-data:/data
      - ./chacheRedis/redis.conf:/redis.conf:ro
      - ./chacheRedis/redis-full.conf:/redis-full.conf:ro
      # Note this would need to be rw if redis was to modify it via ACL commands and save the modifications.
      - ./chacheRedis/users_template.acl:/users_template.acl:ro
      - ./scripts/redis/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
    # environment:
    # - REDIS_HOST=$REDIS_HOST
    # - REDIS_PORT=$REDIS_PORT
    networks:
      - test_network
    command:
      - sh
      - -c
      - sh /usr/local/bin/entrypoint.sh

volumes:
  test-postgres-data:
  test-app-data:
  test-redis-data:

networks:
  test_network:
